name: Build & Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.22'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GCP_PROJECT: malaria-487614
  GCP_ZONE: africa-south1-a
  VM_NAME: malaria-vm
  VM_USER: web2a
  DEPLOY_DIR: /home/web2a/sigec-ve

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(git describe --tags --always 2>/dev/null || echo "dev-$(git rev-parse --short HEAD)")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests
        run: |
          go test ./internal/service/auth/... \
                   ./internal/service/device/... \
                   ./internal/service/transaction/... \
                   -v -count=1
        continue-on-error: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-vm:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: http://34.35.36.178:8082
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Deploy to VM
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT }} \
            --command="
              set -e

              # Create deploy directory
              mkdir -p ${{ env.DEPLOY_DIR }}
              cd ${{ env.DEPLOY_DIR }}

              # Login to GHCR
              echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

              # Pull latest image
              docker pull ghcr.io/${{ github.repository }}:latest

              # Stop old container (ignore if not running)
              docker stop sigec-api 2>/dev/null || true
              docker rm sigec-api 2>/dev/null || true

              # Start new container
              docker run -d \
                --name sigec-api \
                --restart unless-stopped \
                --network host \
                -e HTTP_PORT=8082 \
                -e DATABASE_URL='postgres://sigec:SigecVE2026@localhost:5433/sigec_ve?sslmode=disable' \
                -e REDIS_URL='redis://localhost:6379/1' \
                -e NATS_URL='' \
                -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
                -e GEMINI_API_KEY='${{ secrets.GEMINI_API_KEY }}' \
                -e STRIPE_SECRET_KEY='${{ secrets.STRIPE_SECRET_KEY }}' \
                -e APP_ENVIRONMENT=production \
                -e LOG_LEVEL=info \
                -p 8082:8082 \
                -p 9000:9000 \
                -p 50051:50051 \
                ghcr.io/${{ github.repository }}:latest

              # Ensure PostgreSQL container exists
              if ! docker ps --format '{{.Names}}' | grep -q sigec-postgres; then
                docker run -d \
                  --name sigec-postgres \
                  --restart unless-stopped \
                  -e POSTGRES_USER=sigec \
                  -e POSTGRES_PASSWORD=SigecVE2026 \
                  -e POSTGRES_DB=sigec_ve \
                  -p 5433:5432 \
                  -v sigec_pg_data:/var/lib/postgresql/data \
                  postgres:16-alpine
              fi

              # Cleanup old images
              docker image prune -f

              echo 'Deploy complete!'
            "

      - name: Health check
        run: |
          echo "Waiting for service to start..."
          sleep 15
          for i in $(seq 1 12); do
            if gcloud compute ssh ${{ env.VM_NAME }} \
              --zone=${{ env.GCP_ZONE }} \
              --project=${{ env.GCP_PROJECT }} \
              --command="curl -sf http://localhost:8082/health/live" 2>/dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i/12 - waiting..."
            sleep 10
          done
          echo "Health check failed"
          exit 1

      - name: Show deploy info
        if: always()
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **VM:** ${{ env.VM_NAME }} (34.35.36.178)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** http://34.35.36.178:8082" >> $GITHUB_STEP_SUMMARY
          echo "- **OCPP:** ws://34.35.36.178:9000" >> $GITHUB_STEP_SUMMARY
          echo "- **gRPC:** 34.35.36.178:50051" >> $GITHUB_STEP_SUMMARY
