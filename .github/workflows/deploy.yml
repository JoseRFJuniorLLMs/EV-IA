name: Build & Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  VM_IP: ${{ secrets.VM_IP }}
  VM_USER: web2a

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests
        run: |
          go test ./internal/service/auth/... \
                   ./internal/service/device/... \
                   ./internal/service/transaction/... \
                   -v -count=1

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.VM_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "Host *
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new" > ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Upload source and build on VM
        run: |
          # Archive source (exclude .git)
          tar czf /tmp/ev-ia.tar.gz --exclude='.git' --exclude='frontend' --exclude='node_modules' .

          # Upload to VM
          ssh ${{ env.VM_USER }}@${{ env.VM_IP }} "rm -rf /tmp/ev-ia-src && mkdir -p /tmp/ev-ia-src"
          scp /tmp/ev-ia.tar.gz ${{ env.VM_USER }}@${{ env.VM_IP }}:/tmp/ev-ia.tar.gz

          # Build Docker image and restart container on VM
          ssh ${{ env.VM_USER }}@${{ env.VM_IP }} '
            set -e

            cd /tmp/ev-ia-src
            tar xzf /tmp/ev-ia.tar.gz

            echo "Building Docker image..."
            sudo docker build -t ev-ia:latest .

            echo "Stopping old container..."
            sudo docker stop ev-ia 2>/dev/null || true
            sudo docker rm ev-ia 2>/dev/null || true

            echo "Starting new container..."
            sudo docker run -d \
              --name ev-ia \
              --restart unless-stopped \
              --network host \
              -e HTTP_PORT=8083 \
              -e APP_GRPC_PORT=50053 \
              -e APP_OCPP_PORT=9001 \
              -e DATABASE_URL="postgres://postgres:Debian23%40@localhost:5432/ev-db?sslmode=disable" \
              -e REDIS_URL="redis://localhost:6379/0" \
              -e NATS_URL="" \
              -e JWT_SECRET="'"${{ secrets.JWT_SECRET }}"'" \
              -e GEMINI_API_KEY="'"${{ secrets.GEMINI_API_KEY }}"'" \
              -e STRIPE_SECRET_KEY="'"${{ secrets.STRIPE_SECRET_KEY }}"'" \
              -e APP_ENVIRONMENT=production \
              -e LOG_LEVEL=info \
              -e APP_SECURITY_ENABLE_HTTPS=false \
              -e APP_SECURITY_ENABLE_MTLS=false \
              ev-ia:latest

            # Cleanup
            sudo docker image prune -f
            rm -rf /tmp/ev-ia-src /tmp/ev-ia.tar.gz

            echo "Deploy complete!"
          '

      - name: Health check
        run: |
          echo "Waiting for service to start..."
          sleep 10
          for i in 1 2 3 4 5; do
            HTTP_CODE=$(curl -sk -o /dev/null -w "%{http_code}" --connect-timeout 10 https://${{ env.VM_IP }}/ev-api/v1/auth/register || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"
            if [ "$HTTP_CODE" != "000" ]; then
              echo "EV-IA backend is responding"
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed"
          exit 1

      - name: Notify
        if: always()
        run: echo "EV-IA deploy ${{ job.status }} - commit ${{ github.sha }}"

  notify:
    name: Email Notification
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    steps:
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ contains(needs.*.result, 'failure') && '❌' || '✅' }} ${{ github.workflow }} - ${{ github.ref_name }}"
          to: petweofc@gmail.com,web2ajax@gmail.com
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Workflow: ${{ github.workflow }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
